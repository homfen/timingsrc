!function(t){var e={};function i(n){if(e[n])return e[n].exports;var r=e[n]={i:n,l:!1,exports:{}};return t[n].call(r.exports,r,r.exports,i),r.l=!0,r.exports}i.m=t,i.c=e,i.d=function(t,e,n){i.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},i.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},i.t=function(t,e){if(1&e&&(t=i(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var n=Object.create(null);if(i.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)i.d(n,r,function(e){return t[e]}.bind(null,r));return n},i.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return i.d(e,"a",e),e},i.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},i.p="",i(i.s=0)}([function(t,e,i){"use strict";i.r(e),i.d(e,"utils",(function(){return n})),i.d(e,"motionutils",(function(){return r})),i.d(e,"BinarySearch",(function(){return nt})),i.d(e,"endpoint",(function(){return w})),i.d(e,"eventify",(function(){return ht})),i.d(e,"Interval",(function(){return N})),i.d(e,"ObservableMap",(function(){return ut})),i.d(e,"Timeout",(function(){return _t})),i.d(e,"TimingObject",(function(){return Et})),i.d(e,"SkewConverter",(function(){return kt})),i.d(e,"DelayConverter",(function(){return bt})),i.d(e,"ScaleConverter",(function(){return It})),i.d(e,"LoopConverter",(function(){return Tt})),i.d(e,"RangeConverter",(function(){return Rt})),i.d(e,"TimeshiftConverter",(function(){return Dt})),i.d(e,"Dataset",(function(){return jt})),i.d(e,"Sequencer",(function(){return fe})),i.d(e,"version",(function(){return pe}));var n={};i.r(n),i.d(n,"eqSet",(function(){return o})),i.d(n,"all",(function(){return s})),i.d(n,"isIn",(function(){return a})),i.d(n,"map_difference",(function(){return l})),i.d(n,"map_intersect",(function(){return h})),i.d(n,"divmod",(function(){return c})),i.d(n,"isIterable",(function(){return u})),i.d(n,"array_concat",(function(){return _})),i.d(n,"object_equals",(function(){return d})),i.d(n,"docready",(function(){return f}));var r={};function o(t,e){return t.size===e.size&&s(a(e),t)}function s(t,e){for(var i of e)if(!t(i))return!1;return!0}function a(t){return function(e){return t.has(e)}}i.r(r),i.d(r,"equalVectors",(function(){return V})),i.d(r,"copyVector",(function(){return U})),i.d(r,"calculateVector",(function(){return z})),i.d(r,"calculateDirection",(function(){return j})),i.d(r,"isMoving",(function(){return B})),i.d(r,"RangeState",(function(){return q})),i.d(r,"correctRangeState",(function(){return G})),i.d(r,"checkRange",(function(){return F})),i.d(r,"rangeIntersect",(function(){return X})),i.d(r,"calculateDelta",(function(){return W})),i.d(r,"posInterval_from_timeInterval",(function(){return K})),i.d(r,"timeEndpoint_from_posEndpoint",(function(){return J})),i.d(r,"endpointEvents",(function(){return Z})),i.d(r,"MotionDelta",(function(){return tt}));const l=function(t,e){return 0==t.size?new Map:0==e.size?t:new Map([...t].filter((function([t,i]){return!e.has(t)})))},h=function(t,e){return[t,e]=t.size<=e.size?[t,e]:[e,t],0==t.size?new Map:new Map([...t].filter((function([t,i]){return e.has(t)})))};function c(t,e){let i=t%e;return[(t-i)/e,i]}function u(t){return null!=t&&"function"==typeof t[Symbol.iterator]}function _(t,e={}){let{copy:i=!1,order:n=!1}=e;if(0==t.length)return[];if(1==t.length)return t[0];let r=t.reduce((t,e)=>t+e.length,0);n||t.sort((t,e)=>e.length-t.length);let o,s,a=i?[]:t.shift(),l=a.length;a.length=r;for(let e of t){s=e.length,o=l+s;for(let t=0;t<s;t++)a[l+t]=e[t];l=o}return a}function d(t,e){let i,n=Object.getOwnPropertyNames(t),r=Object.getOwnPropertyNames(e),o=n.length;if(n.length!=r.length)return!1;for(let r=0;r<o;r++)if(i=n[r],t[i]!==e[i])return!1;return!0}const f=new Promise((function(t){if("complete"===document.readyState)t();else{let e=function(){t(),document.removeEventListener("DOMContentLoaded",e,!0),window.removeEventListener("load",e,!0)};document.addEventListener("DOMContentLoaded",e,!0),window.addEventListener("load",e,!0)}})),p=function(t){let e=parseFloat(t);return t===e&&!isNaN(e)};function v(t,e,i,n){if(t==1/0&&(0==e||0==i))throw new Error("Infinity endpoint must be right-closed or singular");if(t==-1/0&&(1==e||0==i))throw new Error("-Infinity endpoint must be left-closed or singular");return[t,e,i,n]}function g(t){let[e,i,n,r]=t;return null==i?2:i?n?3:0:n?1:4}function m(t,e){if(void 0===t.length){if(!p(t))throw new Error("e1 not a number",t);t=v(t,void 0,void 0,!0)}if(void 0===e.length){if(!p(e))throw new Error("e2 not a number",e);e=v(e,void 0,void 0,!0)}return t[0]!=e[0]?[t[0],e[0]]:[g(t),g(e)]}function y(t,e){let[i,n]=m(t,e),r=i-n;return 0==r?0:r>0?1:-1}var w={cmp:y,toString:function(t){if(void 0===t.length)return t.toString();{let e=g(t),i=t[0];if(i!=1/0&&i!=-1/0||(i="--"),0==e)return i+")";if(1==e)return"["+i;if(2==e)return`[${i}]`;if(3==e)return i+"]";if(4==e)return"("+i}},equals:function(t,e){let[i,n]=m(t,e);return i==n},rightof:function(t,e){let[i,n]=m(t,e);return i>n},leftof:function(t,e){let[i,n]=m(t,e);return i<n},create:v,min:function(t,e){return y(t,e)<=0?t:e},max:function(t,e){return y(t,e)<=0?e:t}};const E=function(t){let e=parseFloat(t);return t===e&&!isNaN(e)};class k extends Error{constructor(t){super(t),this.name}}const b=Object.freeze({OUTSIDE_LEFT:64,OVERLAP_LEFT:32,COVERED:16,EQUALS:8,COVERS:4,OVERLAP_RIGHT:2,OUTSIDE_RIGHT:1}),I=b.OUTSIDE_LEFT+b.OUTSIDE_RIGHT,O=b.EQUALS+b.COVERED,T=O+b.OVERLAP_LEFT+b.OVERLAP_RIGHT,S=T+b.COVERS,R=S+I;class D{static fromEndpoints(t,e){let[i,n,r,o]=t,[s,a,l,h]=e;if(n)throw new k("illegal endpointLow - bracket must be left");if(!a)throw new k("illegal endpointHigh - bracket must be right");return new D(i,s,r,l)}constructor(t,e,i,n){var r=E(t);E(e);if(r&&void 0===e&&(e=t),!E(t))throw new k("low not a number");if(!E(e))throw new k("high not a number");if(t>e)throw new k("low > high");if(t===e&&(i=!0,n=!0),t===-1/0&&(i=!0),e===1/0&&(n=!0),void 0===i&&(i=!0),void 0===n&&(n=!1),"boolean"!=typeof i)throw new k("lowInclude not boolean");if("boolean"!=typeof n)throw new k("highInclude not boolean");this.low=t,this.high=e,this.lowInclude=i,this.highInclude=n,this.length=this.high-this.low,this.singular=this.low===this.high,this.finite=isFinite(this.low)&&isFinite(this.high),this.endpointLow=w.create(this.low,!1,this.lowInclude,this.singular),this.endpointHigh=w.create(this.high,!0,this.highInclude,this.singular)}toString(){w.toString;if(this.singular){return`[${this.endpointLow[0]}]`}return`${w.toString(this.endpointLow)},${w.toString(this.endpointHigh)}`}covers_endpoint(t){let e=w.leftof(t,this.endpointLow),i=w.rightof(t,this.endpointHigh);return!e&&!i}compare(t){return x(this,t)}equals(t){return x(this,t)==b.EQUALS}match(t,e=S){let i=x(this,t);return Boolean(e&i)}}var M,L,A;function x(t,e){if(!t instanceof D){if(!E(t))throw new k("a not interval",t);t=new D(t)}if(!e instanceof D){if(!E(e))throw new k("b not interval",e);e=new D(e)}let i=10*w.cmp(t.endpointLow,e.endpointLow)+w.cmp(t.endpointHigh,e.endpointHigh);return 11==i?w.leftof(e.endpointHigh,t.endpointLow)?b.OUTSIDE_RIGHT:b.OVERLAP_RIGHT:[-1,9,10].includes(i)?b.COVERED:[1,-9,-10].includes(i)?b.COVERS:0==i?b.EQUALS:w.rightof(e.endpointLow,t.endpointHigh)?b.OUTSIDE_LEFT:b.OVERLAP_LEFT}function P(t){return function(e,i){let n,r;return t?(n=[e.low,!1,e.lowInclude,e.singular],r=[i.low,!1,i.lowInclude,e.singular]):(n=[e.high,!0,e.highInclude,e.singular],r=[i.high,!0,i.highInclude,e.singular]),w.cmp(n,r)}}M=D,L="Match",A=Object.freeze({OUTSIDE:I,INSIDE:O,OVERLAP:T,COVERS:S,ALL:R}),L in M?Object.defineProperty(M,L,{value:A,enumerable:!0,configurable:!0,writable:!0}):M[L]=A,D.Relation=b,D.cmpLow=P(!0),D.cmpHigh=P(!1);var N=D;function C(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}const H=function(t,e){return t-e};function V(t,e){let i=t.position==e.position,n=t.velocity==e.velocity,r=t.acceleration==e.acceleration,o=t.timestamp==e.timestamp;return i&&n&&r&&o}function U(t){return{position:t.position,velocity:t.velocity,acceleration:t.acceleration,timestamp:t.timestamp}}function z(t,e){if(void 0===e)throw new Error("no ts provided for calculateVector");const i=e-t.timestamp;return{position:t.position+t.velocity*i+.5*t.acceleration*i*i,velocity:t.velocity+t.acceleration*i,acceleration:t.acceleration,timestamp:e}}function j(t,e){let i;i=null==e?t:z(t,e);let n=H(i.velocity,0);return 0===n&&(n=H(t.acceleration,0)),n}function B(t){return 0!==t.velocity||0!==t.acceleration}const q=Object.freeze({INIT:"init",INSIDE:"inside",OUTSIDE_LOW:"outsidelow",OUTSIDE_HIGH:"outsidehigh"});function G(t,e){const{position:i,velocity:n,acceleration:r}=t;if(i>e[1])return q.OUTSIDE_HIGH;if(i<e[0])return q.OUTSIDE_LOW;if(i===e[1]){if(n>0)return q.OUTSIDE_HIGH;if(0===n&&r>0)return q.OUTSIDE_HIGH}else if(i===e[0]){if(n<0)return q.OUTSIDE_LOW;if(0==n&&r<0)return q.OUTSIDE_HIGH}return q.INSIDE}function F(t,e){const i=G(t,e);return i!==q.INSIDE&&(t.velocity=0,t.acceleration=0,i===q.OUTSIDE_HIGH?t.position=e[1]:t.position=e[0]),t}function X(t,e){let i=t.timestamp,n=Y(t,e[0]),r=Y(t,e[1]);return void 0!==n&&void 0!==r?n<r?[i+n,e[0]]:[i+r,e[1]]:void 0!==n?[i+n,e[0]]:void 0!==r?[i+r,e[1]]:[void 0,void 0]}function $(t,e,i,n){return Math.pow(e,2)-2*i*(t-n)>=0}function Q(t,e,i,n){if(0===i&&0===e)return t!=n?[]:[0];if(0===i)return[(n-t)/e];if(!1===$(t,e,i,n))return[];if(0===e*e-2*i*(t-n))return[-e/i];const r=Math.sqrt(Math.pow(e,2)-2*i*(t-n)),o=(-e+r)/i,s=(-e-r)/i;return[Math.min(o,s),Math.max(o,s)]}function Y(t,e){const{position:i,velocity:n,acceleration:r}=t,o=function(t,e,i,n){const r=Q(t,e,i,n);return 0===r.length?[]:1==r.length?r[0]>0?[r[0]]:[]:2==r.length?r[1]<0?[]:r[0]>0?[r[0],r[1]]:r[1]>0?[r[1]]:[]:[]}(i,n,r,e);return 0===o.length?void 0:o[0]}function W(t,e){const i=Y(t,e[0]),n=Y(t,e[1]);return void 0!==i&&void 0!==n?i<n?[i,e[0]]:[n,e[1]]:void 0!==i?[i,e[0]]:void 0!==n?[n,e[1]]:[void 0,void 0]}function K(t,e){if(!B(e)||t.singular)return new N(e.position);let i=t.low,n=t.high,r=t.lowInclude,o=t.highInclude,s=z(e,i),a=s.position,l=s.velocity,h=s.acceleration,c=z(e,n).position;if(0!=h){let e=-l/h+i;if(t.covers_endpoint(e)){let t=-l*l/(2*h)+a;return h>0?a<c?new N(t,c,!0,o):new N(t,a,!0,r):a<c?new N(a,t,r,!0):new N(c,t,o,!0)}}return a<c?new N(a,c,r,o):new N(c,a,o,r)}function J(t,e,i){let[n,r,o,s]=t;return i<0&&void 0!==r&&(r=!r),[e,r,o,s]}function Z(t,e,i,n){if(t.singular)throw new Error("getEventItems: timeInterval is singular");if(!B(i))throw new Error("getEventItems: no motion");let r,o,s,a,l,h=i.position,c=i.velocity,u=i.acceleration,_=i.timestamp,d=[];n.forEach((function(n){e.covers_endpoint(n.endpoint)&&(r=n.endpoint[0],$(h,c,u,r)&&(s=Q(h,c,u,r),s.forEach((function(e){o=_+e,l=j(i,o),a=J(n.endpoint,o,l),t.covers_endpoint(a)&&(n.tsEndpoint=a,n.direction=l,d.push(n))}))))}));return d.sort((function(t,e){return w.cmp(t.tsEndpoint,e.tsEndpoint)})),d}class tt{constructor(t,e){let i=e.timestamp,n=B(e),r=null==t||null==t.position;const o=tt.PosDelta,s=tt.MoveDelta;if(r)this._mc=n?[o.CHANGE,s.START]:[o.CHANGE,s.NOOP];else{let r,a=B(t),l=z(t,i),h=z(e,i),c=l.position!=h.position?o.CHANGE:o.NOOP;if(a&&n){let t=l.velocity!=h.velocity,e=l.acceleration!=h.acceleration;r=t||e?s.CHANGE:s.NOOP_MOVING}else!a&&n?r=s.START:a&&!n?r=s.STOP:a||n||(r=s.NOOP);this._mc=[c,r]}}get posDelta(){return this._mc[0]}get moveDelta(){return this._mc[1]}toString(){const t=tt.PosDelta,e=tt.MoveDelta;let i=this.posDelta==t.CHANGE?"jump, ":"";return this.moveDelta==e.START?i+="movement started":this.moveDelta==e.CHANGE?i+="movement changed":this.moveDelta==e.STOP?i+="movement stopped":this.moveDelta==e.NOOP_MOVING?i+="movement noop - moving":this.moveDelta==e.NOOP&&(i+="movement noop - not moving"),i}}C(tt,"PosDelta",Object.freeze({NOOP:0,CHANGE:1})),C(tt,"MoveDelta",Object.freeze({NOOP:0,NOOP_MOVING:1,START:2,CHANGE:3,STOP:4}));class et extends Error{constructor(t){super(t),this.name="BinarySearchError"}}function it(t,e){return t-e}var nt=class{constructor(t){!function(t,e,i){e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}(this,"getMaximum",(function(){return this.array.length>0?this.array[this.array.length-1]:void 0})),this.array=[],this.options=t||{}}binaryIndexOf(t){let e,i,n=0,r=this.array.length-1;for(;n<=r;)if(e=(n+r)/2|0,i=this.array[e],i<t)n=e+1;else{if(!(i>t))return e;r=e-1}return~r}isFound(t,e){return t>0||0==t&&this.array.length>0&&this.array[0]==e}indexOf(t){var e=this.binaryIndexOf(t);return this.isFound(e,t)?e:-1}indexOfElements(t){let e,i,n=[];for(let r=0;r<t.length;r++)e=t[r],i=this.indexOf(e),i>-1&&n.push(i);return n}has(t){return this.indexOf(t)>-1}get(t){return this.array[t]}_update_splice(t,e,i){if(this.array.length>0){let e=this.indexOfElements(t);e.sort((function(t,e){return t-e}));for(let t=e.length-1;t>-1;t--)this.array.splice(e[t],1)}let n,r,o=e.length;for(let t=0;t<o;t++)n=e[t],r=this.binaryIndexOf(n),this.isFound(r,n)||this.array.splice(Math.abs(r),0,n)}_update_sort(t,e,i){if(this.array.length>0&&t.length>0){let e=this.indexOfElements(t);for(let t=0;t<e.length;t++)this.array[e[t]]=void 0}if(this.array=this.array.concat(e),this.array.sort(it),t.length>0){let t=this.array.indexOf(void 0);t>-1&&this.array.splice(t,this.array.length-t)}var n;this.array=(n=this.array,[...new Set(n)])}update(t,e,i){let n=t.length+e.length;if(0==n)return;let r=(o=this.array.length,s=n,0==o?"sort":s<=100?"splice":"sort");var o,s;"splice"==r?this._update_splice(t,e,i):"sort"==r&&this._update_sort(t,e,i)}getMinimum(){return this.array.length>0?this.array[0]:void 0}ltIndexOf(t){var e=this.binaryIndexOf(t);return this.isFound(e,t)?e>0?e-1:-1:Math.abs(e)-1}leIndexOf(t){var e=this.binaryIndexOf(t);return this.isFound(e,t)||(e=Math.abs(e)-1)>=0?e:-1}gtIndexOf(t){var e=this.binaryIndexOf(t);if(this.isFound(e,t))return e<this.array.length-1?e+1:-1;{let t=Math.abs(e);return t<this.array.length?t:-1}}geIndexOf(t){var e=this.binaryIndexOf(t);return this.isFound(e,t)||(e=Math.abs(e))<this.array.length?e:-1}lookupIndexes(t){if(void 0===t&&(t=new N(-1/0,1/0,!0,!0)),t instanceof N==!1)throw new et("lookup requires Interval argument");if(t.singular){let e=this.indexOf(t.low);return e>-1?[e,e+1]:[void 0,void 0]}var e=-1,i=-1;return-1===(e=t.lowInclude?this.geIndexOf(t.low):this.gtIndexOf(t.low))||-1===(i=t.highInclude?this.leIndexOf(t.high):this.ltIndexOf(t.high))?[void 0,void 0]:[e,i+1]}lookup(t){let[e,i]=this.lookupIndexes(t);return null!=e?this.array.slice(e,i):[]}remove(t){let[e,i]=this.lookupIndexes(t);return null!=e?this.array.splice(e,i-e):[]}slice(t,e){return this.array.slice(t,e)}splice(t,e){return this.array.splice(t,e)}removeInSlice(t){if(0==t.length)return;const e=t[0],i=t[t.length-1];let[n,r]=this.lookupIndexes(new N(e,i,!0,!0)),o=n,s=n,a=0;for(;o<r;){let e=this.array[o],i=t[a];if(e<i?(this.array[s]=this.array[o],s++,o++):e==i?(o++,a++):a++,a==t.length)break}this.array.splice(s,o-s)}values(){return this.array.values()}clear(){this.array=[]}get length(){return this.array.length}};class rt{constructor(t,e,i){i=i||{},this.publisher=t,this.name=e,this.init=void 0!==i.init&&i.init,this.subscriptions=[]}subscribe(t,e){if(!t||"function"!=typeof t)throw new Error("Callback not a function",t);const i=new ot(this,t,e);if(this.subscriptions.push(i),this.init&&i.init){i.init_pending=!0;let t=this;Promise.resolve().then((function(){const e=t.publisher.eventifyInitEventArgs(t.name)||[];for(let n of e)t.trigger(n,[i],!0);i.init_pending=!1}))}return i}trigger(t,e,i){let n,r;for(const o of e)if(!o.terminated){n={src:this.publisher,name:this.name,sub:o,init:i},r=o.ctx||this.publisher;try{o.callback.call(r,t,n)}catch(t){console.log(`Error in ${this.name}: ${o.callback} ${t}`)}}}unsubscribe(t){let e=this.subscriptions.indexOf(t);e>-1&&(this.subscriptions.splice(e,1),t.terminate())}}class ot{constructor(t,e,i){i=i||{},this.event=t,this.name=t.name,this.callback=e,this.init=void 0===i.init?this.event.init:i.init,this.init_pending=!1,this.terminated=!1,this.ctx=i.ctx}terminate(){this.terminated=!0,this.callback=void 0,this.event.unsubscribe(this)}}function st(t){return t.__eventify_eventMap=new Map,t.__eventify_buffer=[],t}function at(t){function e(t,e){const i=t.__eventify_eventMap.get(e);if(null==i)throw new Error("Event undefined",e);return i}t.eventifyDefine=function(t,e){if(this.__eventify_eventMap.has(t))throw new Error("Event already defined",t);this.__eventify_eventMap.set(t,new rt(this,t,e))},t.eventifyTrigger=function(t,e){return this.eventifyTriggerAll([{name:t,eArg:e}])},t.eventifyTriggerAlike=function(t,e){return this.eventifyTriggerAll(e.map(e=>({name:t,eArg:e})))},t.eventifyTriggerAll=function(t){if(0==t.length)return;let i=t.map(t=>{let{name:i,eArg:n}=t,r=e(this,i),o=r.subscriptions.filter(t=>0==t.init_pending);return[r,n,o]},this);const n=i.length,r=this.__eventify_buffer,o=this.__eventify_buffer.length;this.__eventify_buffer.length=o+n;for(let t=0;t<n;t++)r[o+t]=i[t];if(0==o){let t=this;Promise.resolve().then((function(){for(let[e,i,n]of t.__eventify_buffer)e.trigger(i,n,!1);t.__eventify_buffer=[]}))}},t.eventifySubscriptions=function(t){return e(this,t).subscriptions},t.on=function(t,i,n){return e(this,t).subscribe(i,n)},t.off=function(t){return e(this,t.name).unsubscribe(t)}}class lt{constructor(t){st(this),this._value=t,this.eventifyDefine("change",{init:!0})}eventifyInitEventArgs(t){if("change"==t)return[this._value]}get value(){return this._value}set value(t){t!=this._value&&(this._value=t,this.eventifyTrigger("change",t))}}at(lt.prototype);var ht={eventifyPrototype:at,eventifyInstance:st,EventVariable:lt,EventBoolean:class extends lt{constructor(t){super(Boolean(t))}set value(t){super.value=Boolean(t)}get value(){return super.value}},makePromise:function(t,e){return e=e||function(t){return 1==t},new Promise((function(i,n){let r=t.on("change",(function(n){e(n)&&(i(n),t.off(r))}))}))}};class ct{constructor(){this._map=new Map,ht.eventifyInstance(this),this.eventifyDefine("batch",{init:!0}),this.eventifyDefine("change",{init:!0}),this.eventifyDefine("remove",{init:!1})}_sortItems(t){return t}eventifyInitEventArgs(t){if("batch"==t||"change"==t){let e=[...this._map.entries()].map(([t,e])=>({key:t,new:e,old:void 0}));return e=this._sortItems(e),"batch"==t?[e]:e}}_notifyEvents(t){if(0==t.length)return;const e=this.eventifySubscriptions("batch").length>0,i=this.eventifySubscriptions("remove").length>0,n=this.eventifySubscriptions("change").length>0;if(e&&this.eventifyTrigger("batch",t),i||n)for(let e of t)null==e.new&&null!=e.old?i&&this.eventifyTrigger("remove",e):n&&this.eventifyTrigger("change",e)}get size(){return this._map.size}has(t){return this._map.has(t)}get(t){return this._map.get(t)}keys(){return this._map.keys()}values(){return this._map.values()}entries(){return this._map.entries()}set(t,e){let i=void 0;return this._map.has(t)&&(i=this._map.get(t)),this._map.set(t,e),this._notifyEvents([{key:t,new:e,old:i}]),this}delete(t){let e=!1,i=void 0;return this._map.has(t)&&(i=this._map.get(t),this._map.delete(t),e=!0),this._notifyEvents([{key:t,new:void 0,old:i}]),e}clear(){let t=this._map;this._map=new Map;const e=[];for(let[i,n]of t.entries())e.push({key:i,new:void 0,old:n});this._notifyEvents(e)}}ht.eventifyPrototype(ct.prototype);var ut=ct;var _t=class{constructor(t,e){this.tid=void 0,this.to=t,this.callback=e}isSet(){return null!=this.tid}setTimeout(t,e){if(null!=this.tid)throw new Error("at most on timeout");let i=this.to.clock.now(),n=1e3*Math.max(t-i,0);this.tid=setTimeout(this.onTimeout.bind(this),n,t,e)}onTimeout(t,e){if(null!=this.tid){this.tid=void 0;let i=this.to.clock.now();i<t?this.setTimeout(t,e):this.callback(i,e)}}clear(){null!=this.tid&&(clearTimeout(this.tid),this.tid=void 0)}};"performance"in window==0&&(window.performance={},window.performance.offset=(new Date).getTime()),"now"in window.performance==0&&(window.performance.now=function(){return(new Date).getTime()-window.performance.offset});const dt=function(){return performance.now()/1e3};function ft(t,e){void 0===e&&(e=dt());var i=e-t.timestamp;return{position:t.position+t.velocity*i,velocity:t.velocity,timestamp:e}}class pt{constructor(t){var e=dt();t=t||{},this._vector={position:e,velocity:1,timestamp:e},ht.eventifyInstance(this),this.eventifyDefine("change",{init:!1}),this.adjust(t)}adjust(t){t=t||{};var e=dt(),i=this.query(e);void 0===t.skew&&void 0===t.rate||(this._vector={position:void 0!==t.skew?e+t.skew:i.position,velocity:void 0!==t.rate?t.rate:i.velocity,timestamp:i.timestamp},this.eventifyTrigger("change"))}now(){return ft(this._vector,dt()).position}query(t){return ft(this._vector,t)}}ht.eventifyPrototype(pt.prototype);var vt=pt;var gt=class{constructor(t,e){e=e||{},this._clock=new vt({skew:0}),this._range=[-1/0,1/0],this._vector,this._callback=t,e.timestamp=e.timestamp||this._clock.now(),this._process_update(e)}get clock(){return this._clock}get range(){return this._range}get vector(){return this._vector}isReady(){return!0}_process_update(t){let{position:e,velocity:i,acceleration:n,timestamp:r,range:o,...s}=t,a=0,l=0,h=0;if(null!=this._vector){let t=z(this._vector,r);t=F(t,this._range),a=t.position,l=t.velocity,h=t.acceleration}let c={position:null!=e?e:a,velocity:null!=i?i:l,acceleration:null!=n?n:h,timestamp:r};if(null!=o){let[t,e]=o;t<e&&(t==this._range[0]&&e==this._range[1]||(this._range=[t,e]))}return c=F(c,this._range),this._old_vector=this._vector,this._vector=c,{range:o,...c,...s}}update(t){return t=this._process_update(t),this._callback(t)}close(){this._callback=void 0}};var mt=class{constructor(t,e,i){!function(t){let e=["on","skew","vector","range","update"];for(let i of e)if(!(i in t))throw new Error(`TimingProvider ${t} missing property ${i}`)}(t),i=i||{},this._provider=t,this._callback=e,this._range,this._vector,this._ready=!1,this._provider_clock,this._clock,this._provider.on("vectorchange",this._onVectorChange.bind(this)),this._provider.on("skewchange",this._onSkewChange.bind(this));if(null!=this._provider.skew){let t=this;Promise.resolve((function(){t._onSkewChange()}))}}isReady(){return this._ready}get clock(){return this._clock}get range(){return this._range}get vector(){let t=this._vector.timestamp-this._provider.skew;return{position:this._vector.position,velocity:this._vector.velocity,acceleration:this._vector.acceleration,timestamp:t}}get provider(){return this._provider}_onSkewChange(){if(this._clock){this._provider_clock.adjust({skew:this._provider.skew});let t=this._provider_clock.now()-this._clock.now(),e=this._provider.skew-t;this._clock.adjust({skew:e})}else this._provider_clock=new vt({skew:this._provider.skew}),this._clock=new vt({skew:0});if(!this.isReady()&&null!=this._provider.vector){this._ready=!0,this._range=this._provider.range,this._vector=this._provider.vector;let t={range:this.range,...this.vector,live:!1};this._callback(t)}}_onVectorChange(){if(this._clock){this._ready||(this._ready=!0),this._range||(this._range=this._provider.range),this._vector=this._provider.vector;let t={range:this.range,...this.vector};this._callback(t)}}update(t){let e={position:t.position,velocity:t.velocity,acceleration:t.acceleration,timestamp:t.timestamp};e.timestamp=e.timestamp+this._provider.skew;this._provider.update(e);return!0}};function yt(t,e,i,n){if(t)return F(i,n);return F(z(i,e),n)}class wt{constructor(t,e){null!=t&&null==e&&(t instanceof wt||function(t){let e=["on","skew","vector","range","update"];for(let i of e)if(!(i in t))return!1;return!0}(t)||(e=t,t=void 0,e.provider?t=e.provider:e.timingsrc&&(t=e.timingsrc))),e=e||{},this.__options=e,null==e.timeout&&(e.timeout=!0),this.__old_vector,this.__vector,this.__range=[-1/0,1/0],this.__timeout=new _t(this,this.__handleTimeout.bind(this)),this.__tid=void 0,this.__timingsrc,this.__sub,this.__update_events=new Map,this.__ready=new ht.EventBoolean,ht.eventifyInstance(this),this.eventifyDefine("timingsrc",{init:!0}),this.eventifyDefine("change",{init:!0}),this.eventifyDefine("rangechange",{init:!0}),this.eventifyDefine("timeupdate",{init:!0}),this.__set_timingsrc(t,e)}eventifyInitEventArgs(t){if(this.__ready.value){if("timingsrc"==t){return[{...this.__vector,range:this.__range,live:!1}]}if("timeupdate"==t)return[void 0];if("change"==t)return[this.__vector];if("rangechange"==t)return[this.__range]}}isReady(){return this.__ready.value}get ready(){return ht.makePromise(this.__ready)}get range(){return[this.__range[0],this.__range[1]]}get vector(){return{position:this.__vector.position,velocity:this.__vector.velocity,acceleration:this.__vector.acceleration,timestamp:this.__vector.timestamp}}get old_vector(){return this.__old_vector}get delta(){return new tt(this.__old_vector,this.__vector)}get clock(){return this.__timingsrc.clock}query(){if(0==this.__ready.value)throw new Error("query before timing object is ready");let t=z(this.__vector,this.clock.now());return this.__timeout.isSet()?((t.position<this.__range[0]||this.__range[1]<t.position)&&this.__process({...this.onRangeViolation(t)}),z(this.__vector,this.clock.now())):t}get pos(){return this.query().position}get vel(){return this.query().velocity}get acc(){return this.query().acceleration}__update(t){return this.__timingsrc instanceof wt?this.__timingsrc.__update(t):this.__timingsrc.update(t)}update(t){let e=null!=t.range;if(e=e||null!=t.position,e=e||null!=t.velocity,e=e||null!=t.acceleration,!e)return Promise.resolve(t);t.tunnel=Math.floor(1e4*Math.random()),null==t.timestamp&&(t.timestamp=this.clock.now());let i=new ht.EventVariable;this.__update_events.set(t.tunnel,i);let n=ht.makePromise(i,t=>null!=t);return this.__update(t),n}__handleEvent(t){let{range:e,live:i=!0,...n}=t;null!=e&&(e=[e[0],e[1]]);let r={range:e,live:i,...n};if(r=this.onUpdateStart(r),null!=r)return this.__process(r)}__handleTimeout(t,e){this.__process({...this.onRangeViolation(e)})}__process(t){let e,{range:i,position:n,velocity:r,acceleration:o,timestamp:s,live:a=!0,...l}=t,h=!1;if(null!=i){let[t,e]=i;t<e&&(t==this.__range[0]&&e==this.__range[1]||(this.__range=[t,e],i=[t,e],h=!0))}let c,u=!1,_=this.clock.now();if(null!=n?(e={position:n,velocity:r,acceleration:o,timestamp:s},e=yt(a,_,e,this.__range)):h&&(e=yt(!1,_,this.__vector,this.__range)),null!=e&&(u=null==this.__vector||!V(e,this.__vector),u&&(this.__old_vector=this.__vector,this.__vector=e)),c=h&&u?{range:i,...e,live:a,...l}:h?{range:i,live:a,...l}:u?{...e,live:a,...l}:{live:a,...l},this.__ready.value=!0,this.__dispatchEvents(c,h,u),this.__options.timeout&&this.__renewTimeout(),null!=c.tunnel){let t=this.__update_events.get(c.tunnel);t&&(this.__update_events.delete(c.tunnel),delete c.tunnel,t.value=c)}for(let t of this.__update_events.values())t.value={};return this.onUpdateDone(c),c}__dispatchEvents(t,e,i){let{range:n,position:r,velocity:o,acceleration:s,timestamp:a}=t;if(this.eventifyTrigger("timingsrc",t),i){let t={position:r,velocity:o,acceleration:s,timestamp:a};this.eventifyTrigger("change",t)}e&&this.eventifyTrigger("rangechange",n),this.eventifyTrigger("timeupdate");let l=B(this.__vector);if(l&&void 0===this.__tid){let t=this;this.__tid=setInterval((function(){t.eventifyTrigger("timeupdate")}),this.__options.interval||200)}else l||void 0===this.__tid||(clearTimeout(this.__tid),this.__tid=void 0)}onRangeViolation(t){return t}onUpdateStart(t){return t}onUpdateDone(t){}__renewTimeout(t,e){this.__timeout.clear();let i=this.__calculateTimeoutVector(t,e);null!=i&&this.__timeout.setTimeout(i.timestamp,i)}__calculateTimeoutVector(t,e){t=t||this.__vector,e=e||this.__range;let i=this.clock.now(),n=z(t,i),[r,o]=W(n,e);if(null==r||r==1/0)return;let s=z(t,i+r);return s.position=o,s}__clear_timingsrc(){null!=this.__timingsrc&&(this.__timingsrc instanceof wt?(this.__timingsrc.off(this.__sub),this.__sub=void 0,this.__timingsrc=void 0):(this.__timingsrc.close(),this.__timingsrc=void 0))}__set_timingsrc(t,e){let i=this.__handleEvent.bind(this);if(t instanceof wt)this.__timingsrc=t,this.__sub=this.__timingsrc.on("timingsrc",i);else if(this.__timingsrc=null==t?new gt(i,e):new mt(t,i,e),this.__timingsrc.isReady()){i({range:this.__timingsrc.range,...this.__timingsrc.vector,live:!1})}}get timingsrc(){return this.__timingsrc}set timingsrc(t){this.__clear_timingsrc(),this.__set_timingsrc(t)}}ht.eventifyPrototype(wt.prototype);var Et=wt;var kt=class extends Et{constructor(t,e,i){super(t,i),this._skew=e,this.eventifyDefine("skewchange",{init:!0})}eventifyInitEventArgs(t){return"skewchange"==t?[this._skew]:super.eventifyInitEventArgs(t)}onUpdateStart(t){return null!=t.range&&(t.range[0]+=this._skew,t.range[1]+=this._skew),null!=t.position&&(t.position+=this._skew),t}update(t){if(null!=t.position&&(t.position-=this._skew),null!=t.range){let[e,i]=t.range;t.range=[e-this._skew,i-this._skew]}return super.update(t)}get skew(){return this._skew}set skew(t){t!=this._skew&&(this._skew=t,this.__handleEvent({...this.timingsrc.vector,range:this.timingsrc.range}),this.eventifyTrigger("skewchange",t))}};var bt=class extends Et{constructor(t,e){if(e<0)throw new Error("negative delay not supported");if(0===e)throw new Error("zero delay makes delayconverter pointless");super(t),this._delay=e,this._buffer=[],this._timeout=new _t(this,this.__handleDelayed.bind(this)),this.eventifyDefine("delaychange",{init:!0})}eventifyInitEventArgs(t){return"delaychange"==t?[this._delay]:super.eventifyInitEventArgs(t)}onUpdateStart(t){this._buffer.push(t),this._timeout.isSet()||this.__handleDelayed()}__handleDelayed(){let t,e,i=this.clock.now();for(;this._buffer.length>0&&(e=this._buffer[0].timestamp+this._delay,!(i<e));)t=this._buffer.shift(),t.timestamp=e,this.__process(t);this._buffer.length>0&&(e=this._buffer[0].timestamp+this._delay,this._timeout.setTimeout(e))}update(t){throw new Error("update is not legal on delayed (non-live) timingobject")}get delay(){return this._delay}set delay(t){t!=this._delay&&(this._delay=t,this._timeout.clear(),this.__handleDelayed(),this.eventifyTrigger("delaychange",t))}};var It=class extends Et{constructor(t,e){super(t),this._factor=e,this.eventifyDefine("scalechange",{init:!0})}eventifyInitEventArgs(t){return"scalechange"==t?[this._factor]:super.eventifyInitEventArgs(t)}onUpdateStart(t){return null!=t.range&&(t.range=[t.range[0]*this._factor,t.range[1]*this._factor]),null!=t.position&&(t.position*=this._factor),null!=t.velocity&&(t.velocity*=this._factor),null!=t.acceleration&&(t.acceleration*=this._factor),t}update(t){return null!=t.position&&(t.position/=this._factor),null!=t.velocity&&(t.velocity/=this._factor),null!=t.acceleration&&(t.acceleration/=this._factor),super.update(t)}get scale(){return this._factor}set scale(t){t!=this._factor&&(this._factor=t,this.__handleEvent({...this.timingsrc.vector,range:this.timingsrc.range}),this.eventifyTrigger("scalechange",t))}};function Ot(t,e){let i=e[0],n=e[1]-e[0];return i+((t-i)%(r=n)+r)%r;var r}var Tt=class extends Et{constructor(t,e){super(t,{timeout:!0}),this.__range=e}update(t){if(null!=t.range){let[e,i]=t.range;if(e>=i)throw new Error("illegal range",t.range);if(e!=this.__range[0]||i!=this.__range[1]){this.__range=[e,i];let t=this.timingsrc.query();t.position=Ot(t.position,this.__range),this.__vector=t;let n={range:this.__range,...this.__vector,live:!0};this.__dispatchEvents(n,!0,!0)}delete t.range}if(null!=t.position){let e=this.clock.now(),i=z(this.vector,e).position-t.position,n=z(this.timingsrc.vector,e);t.position=n.position-i}return super.update(t)}onRangeViolation(t){return t.position<=this.__range[0]?t.position=this.__range[1]:this.__range[1]<=t.position&&(t.position=this.__range[0]),t}onUpdateStart(t){return null!=t.range&&(t.range=this.__range),null!=t.position&&(t.position=Ot(t.position,this.__range)),t}};function St(){var t=q.INIT,e=null;return{get:function(){return t},set:function(i,n){var r=!1,o=!1;return i===t&&n===e||(r=!0),i!==t&&(o=function(t,e){return(t!==q.OUTSIDE_HIGH||e!==q.OUTSIDE_LOW)&&((t!==q.OUTSIDE_LOW||e!==q.OUTSIDE_HIGH)&&t!==q.INIT)}(t,i)),n!==e&&(e=n),i!==t&&(t=i),{special:o,absolute:r}}}}var Rt=class extends Et{constructor(t,e){super(t,{timeout:!0}),this.__state=St(),this.__range=e}update(t){throw Error("Not Implemented!")}onUpdateStart(t){if(null!=t.range&&delete t.range,null!=t.position){let{position:e,velocity:i,acceleration:n,timestamp:r}=t,o={position:e,velocity:i,acceleration:n,timestamp:r};if(o=this.onVectorChange(o),null==o)return void this.__renewTimeout(this.timingsrc.vector,this.__range);t.position=o.position,t.velocity=o.velocity,t.acceleration=o.acceleration,t.timestamp=o.timestamp}return t}onVectorChange(t){var e=G(t,this.__range),i=this.__state.set(e,this.__range);if(i.special)this.__state.get()===q.INSIDE||(t=F(t,this.__range));else if(this.__state.get()===q.INSIDE);else{if(!i.absolute)return;t=F(t,this.__range)}return t}};var Dt=class extends Et{constructor(t,e){super(t),this._offset=e,this.eventifyDefine("offsetchange",{init:!0})}eventifyInitEventArgs(t){return"offsetchange"==t?[this._offset]:super.eventifyInitEventArgs(t)}onUpdateStart(t){if(null!=t.range&&(t.range=[-1/0,1/0]),null!=t.position){let e=t.timestamp,i=z(t,e+this._offset);t.position=i.position,t.velocity=i.velocity,t.acceleration=i.acceleration,t.timestamp=e}return t}get offset(){return this._offset}set offset(t){t!=this._offset&&(this._offset=t,this.__handleEvent({...this.timingsrc.vector,range:this.timingsrc.range}),this.eventifyTrigger("offsetchange",t))}};function Mt(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}const Lt=N.Relation;var At=function(t,e){if(1==t.length)return t[0].key==e.key&&t.shift(),0==t.length;if(0==t.length)return!0;{let i=t.findIndex((function(t){return t.key==e.key}));return i>-1&&t.splice(i,1),0==t.length}};const xt=[0,10,100,1e3,1e4,1e5,1/0];var Pt=function(t){for(let e=0;e<xt.length;e++)if(t<=xt[e])return xt[e]};const Nt=Object.freeze({NOOP:0,INSERT:1,REPLACE:2,DELETE:3});function Ct(t,e,i){let n,r,o,s=null!=t&&null!=t.interval,a=null!=e&&null!=e.interval;s||a?s?a?(o=t.interval.equals(e.interval),n=o?Nt.NOOP:Nt.REPLACE):n=Nt.DELETE:n=Nt.INSERT:n=Nt.NOOP;let l=null!=t&&null!=t.data,h=null!=e&&null!=e.data;return l||h?l?h?(o=i?i(t.data,e.data):d(t.data,e.data),r=o?Nt.NOOP:Nt.REPLACE):r=Nt.DELETE:r=Nt.INSERT:r=Nt.NOOP,{interval:n,data:r}}function Ht(t,e){return N.cmpLow(t.iterval,e.interval)}function Vt(t,e){return-1*N.cmpHigh(t.iterval,e.interval)}class Ut extends ut{constructor(){super(),this._cueBuckets=new Map;for(let t=0;t<xt.length;t++){let e=xt[t];this._cueBuckets.set(e,new zt(e))}this._update_callbacks=[]}add_callback(t){let e={handler:t};return this._update_callbacks.push(e),e}del_callback(t){let e=this._update_callbacks.indexof(t);e>-1&&this._update_callbacks.splice(e,1)}_notify_callbacks(t,e){this._update_callbacks.forEach((function(i){i.handler(t,e)}))}set(t,e){throw new Error("not implemented")}delete(t){throw new Error("not implemented")}update(t,e){const i=new Map;let n,r,o,s=0==this._map.size;null==(e=e||{}).check&&(e.check=!1),null==e.chaining&&(e.chaining=!0),u(t)||(t=[t]);for(let a of t){if(e.check&&(!a||!a.hasOwnProperty("key")||null==a.key))throw new Error("illegal cue",a);if(r=a.hasOwnProperty("interval"),o=a.hasOwnProperty("data"),e.check&&r&&!a.interval instanceof N)throw new Error("interval must be Interval");n=s?void 0:this._map.get(a.key),null==n?(r||(a.interval=void 0),o||(a.data=void 0)):null!=n&&(r||o?o?r||(a.interval=n.interval):a.data=n.data:(a.interval=void 0,a.data=void 0)),this._update_cue(i,n,a,e)}if(this._call_buckets("flush"),i.size>0){let t={low:1/0,high:-1/0},e=[...i.values()].map(e=>(e.new&&e.new.interval&&(t.low=w.min(t.low,e.new.interval.endpointLow),t.high=w.max(t.high,e.new.interval.endpointHigh)),e.old&&e.old.interval&&(t.low=w.min(t.low,e.old.interval.endpointLow),t.high=w.max(t.high,e.old.interval.endpointHigh)),{key:e.key,new:e.new,old:e.old}));this._notifyEvents(e);let n=void 0;return t.low!=1/0&&(n=N.fromEndpoints(t.low,t.high)),this._notify_callbacks(i,n),e}return[]}_update_cue(t,e,i,n){let r,o,s,a,l,h,c,u,_,d,f=n.equals,p=n.chaining;if(e===i)throw Error("illegal cue arg: same object as current cue");let v=Ct(e,i,f);if(v.interval==Nt.NOOP&&v.data==Nt.NOOP)return s={key:i.key,new:e,old:e,delta:v},void t.set(i.key,s);if(null==e?(r=void 0,o=i,this._map.set(i.key,o)):null==i.interval&&null==i.data?(r=e,o=void 0,this._map.delete(i.key)):(r=function(t){if(null!=t)return{key:t.key,interval:t.interval,data:t.data}}(e),o=e,o.interval=i.interval,o.data=i.data),s={key:i.key,new:o,old:r,delta:v},p&&(a=t.get(i.key),null!=a&&(s.old=a.old,s.delta=Ct(o,s.old,f))),t.set(i.key,s),v.interval!=Nt.NOOP){if(v.interval==Nt.INSERT?(_=!1,d=!0,c=!0,u=!0):v.interval==Nt.DELETE?(_=!0,d=!1,c=!0,u=!0):v.interval==Nt.REPLACE&&(_=!0,d=!0,c=s.new.interval.low!=s.old.interval.low,u=s.new.interval.high!=s.old.interval.high),_){let t=Pt(s.old.interval.length);l=this._cueBuckets.get(t)}if(d){let t=Pt(s.new.interval.length);h=this._cueBuckets.get(t)}l&&h&&l!=h&&(_=!0,d=!0,c=!0,u=!0),c&&(_&&l.del_endpoint(s.old.interval.low,s.old),d&&h.add_endpoint(s.new.interval.low,s.new)),u&&(_&&!s.old.interval.singular&&l.del_endpoint(s.old.interval.high,s.old),d&&!s.new.interval.singular&&h.add_endpoint(s.new.interval.high,s.new))}}_call_buckets(t,...e){const i=[];for(let n of this._cueBuckets.values()){let r=n[t](...e);null!=r&&r.length>0&&i.push(r)}return _(i)}lookup_endpoints(t){return this._call_buckets("lookup_endpoints",t)}lookup(t,e){return this._call_buckets("lookup",t,e)}lookup_delete(t,e){const i=this._call_buckets("lookup_delete",t,e),n=[];let r;for(let t=0;t<i.length;t++)r=i[t],this._map.delete(r.key),n.push({key:r.key,new:void 0,old:r});return this._notifyEvents(n),n}clear(){this._call_buckets("clear");let t=this._map;this._map=new Map;const e=[];for(let i of t.values())e.push({key:i.key,new:void 0,old:i});return this._notifyEvents(e),e}integrity(){const t=this._call_buckets("integrity");let e=[],i=[];for(let n of t.values())e.push(n.cues),i.push(n.points);if(e=[].concat(...e),i=[].concat(...i),i=[...new Set(i)],e.length!=this._map.size)throw new Error("inconsistent cue count _map and aggregate cueBuckets "+e-this._map.size);for(let t of e.values())if(!this._map.has(t.key))throw new Error("inconsistent cues _map and aggregate cueBuckets");return{cues:e.length,points:i.length}}}Mt(Ut,"sort_cues",(function(t,e=0){e>=0?t.sort(Ht):cuess.sort(Vt)})),Mt(Ut,"Delta",Nt),Mt(Ut,"cue_delta",Ct);class zt{constructor(t){this._maxLength=t,this._pointMap=new Map,this._pointIndex=new nt,this._created=new Set,this._dirty=new Set}add_endpoint(t,e){let i=0==this._pointMap.size?void 0:this._pointMap.get(t);null==i?(this._pointMap.set(t,[e]),this._created.add(t)):i.push(e)}del_endpoint(t,e){let i=0==this._pointMap.size?void 0:this._pointMap.get(t);if(null!=i){At(i,e)&&this._dirty.add(t)}}flush(){if(0==this._created.size&&0==this._dirty.size)return;let t=[],e=[];for(let t of this._created.values()){this._pointMap.get(t).length>0?e.push(t):this._pointMap.delete(t)}for(let e of this._dirty.values()){let i=this._pointMap.get(e);null!=i&&(0==i.length&&(t.push(e),this._pointMap.delete(e)))}this._pointIndex.update(t,e),this._created.clear(),this._dirty.clear()}lookup_endpoints(t){if(0==this._pointMap.size)return[];const e=new N(t.low,t.high,!0,!0),i=this._pointIndex.lookup(e),n=[],r=i.length;let o,s;for(let e=0;e<r;e++)o=i[e],this._pointMap.get(o).forEach((function(e){if(o==e.interval.low)s=e.interval.endpointLow;else{if(o!=e.interval.high)throw console.log(o),console.log(e),new Error("fatal: point cue mismatch");s=e.interval.endpointHigh}t.covers_endpoint(s)&&n.push({endpoint:s,cue:e})}));return n}_lookup_cues(t){if(0==this._pointMap.size)return[];const e=new N(t.low,t.high,!0,!0),i=this._pointIndex.lookup(e),n=i.length,r=new Set,o=[];for(let t=0;t<n;t++)this._pointMap.get(i[t]).forEach((function(t){r.has(t.key)||(r.add(t.key),o.push(t))}));return o}lookup(t,e=N.Match.COVERS){if(0==this._pointMap.size)return[];let i=[];if((e&=N.Match.COVERS)==Lt.EQUALS)return this._pointMap.get(t.low).filter((function(e){return e.interval.match(t,Lt.EQUALS)}));let n=e&N.Match.OVERLAP;if(n&&(i=this._lookup_cues(t).filter((function(e){return e.interval.match(t,n)}))),t.length>this._maxLength)return i;if(e&Lt.COVERS){let e=t.high-this._maxLength,n=t.low;[e,n]=[Math.min(e,n),Math.max(e,n)];let r=new N(e,n,!0,!0);this._lookup_cues(r).forEach((function(e){e.interval.match(t,Lt.COVERS)&&i.push(e)}))}return i}lookup_delete(t,e){const i=this.lookup(t,e),n=[];let r,o,s;for(let t=0;t<i.length;t++){r=i[t],s=r.interval.singular?[r.interval.low]:[r.interval.low,r.interval.high];for(let t=0;t<s.length;t++){o=s[t],At(this._pointMap.get(o),r)&&(this._pointMap.delete(o),n.push(o))}}return n.sort((function(t,e){return t-e})),this._pointIndex.removeInSlice(n),i}clear(){this._pointMap.clear(),this._pointIndex=new nt,this._created.clear(),this._dirty.clear()}integrity(){if(this._pointMap.size!==this._pointIndex.length)throw new Error("unequal number of points "+(this._pointMap.size-this._pointIndex.length));const t=new Set;for(let e of this._pointIndex.values())this._pointMap.has(e)||t.add(e);if(t.size>0)throw new Error("differences in points "+[...t]);let e=[];for(let t of this._pointMap.values())for(let i of t.values())e.push(i);e=[...new Map(e.map((function(t){return[t.key,t]}))).values()];for(let t of e.values()){if(t.interval.length>this._maxLength)throw new Error("cue interval violates maxLength ",t);let e;e=t.singular?[t.interval.low]:[t.interval.low,t.interval.high];for(let t of e.values())if(!this._pointIndex.has(t))throw new Error("point from pointMap cue not found in pointIndex ",t)}return[{maxLength:this._maxLength,points:[...this._pointMap.keys()],cues:e}]}}var jt=Ut;const Bt=K;function qt(t,e){return w.cmp(t.tsEndpoint,e.tsEndpoint)}class Gt{constructor(t,e,i){this.to=e,this.timeout=new _t(e,this.run.bind(this)),this.vector,this.timeInterval,this.posInterval,this.axis=t,this.queue=[],this.callbacks=[],(i=i||{}).lookahead=i.lookahead||Gt.LOOKAHEAD,this.options=i}add_callback(t){let e={handler:t};return this.callbacks.push(e),e}del_callback(t){let e=this.callbacks.indexof(t);e>-1&&this.callbacks.splice(e,1)}_notify_callbacks(...t){this.callbacks.forEach((function(e){e.handler(...t)}))}setVector(t){let e=t.timestamp;this.vector;null!=this.vector&&(this.timeout.clear(),this.timeInterval=void 0,this.posInterval=void 0,this.queue=[]),this.vector=t,B(this.vector)&&this.run(e)}push(t){t.forEach((function(t){this.timeInterval.covers_endpoint(t.tsEndpoint)&&this.queue.push(t)}),this),this.queue.sort(qt)}pop(t){let e=[];this.queue.length;for(;this.queue.length>0&&this.queue[0].tsEndpoint[0]<=t;)e.push(this.queue.shift());return e}next(){return this.queue.length>0?this.queue[0].tsEndpoint[0]:void 0}advance(t){let e,i=this.options.lookahead,n=!1;return null==this.timeInterval?(e=t,n=!0):w.leftof(this.timeInterval.endpointHigh,t)&&(e=this.timeInterval.high,n=!0),n&&(this.timeInterval=new N(e,e+i,!0,!1),this.posInterval=Bt(this.timeInterval,this.vector),this.queue=[]),n}load(t,e){let i=Z(this.timeInterval,this.posInterval,this.vector,t),n=X(this.vector,this.to.range)[0];return null==e&&(e=this.timeInterval.endpointLow),i.filter((function(t){if(n<=t.tsEndpoint[0])return!1;if(w.leftof(t.tsEndpoint,e))return!1;if(0!=this.vector.acceleration){let e=t.tsEndpoint[0];if(e>this.timeInterval.endpointLow[0]){let i=z(this.vector,e);if(i.position==t.endpoint[0]&&0==i.velocity)return!1}}return!0}),this)}run(t){let e=this.pop(t);if(this.advance(t)){let i=this.axis.lookup_endpoints(this.posInterval);this.push(this.load(i)),e.push(...this.pop(t))}e.length>0&&this._notify_callbacks(t,e,this);let i=this.next()||this.timeInterval.high;this.timeout.setTimeout(Math.min(i,this.timeInterval.high))}}!function(t,e,i){e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}(Gt,"LOOKAHEAD",5);var Ft=Gt;function Xt(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function $t(t){return t.interval==jt.Delta.NOOP&&t.data==jt.Delta.NOOP}const Qt=Object.freeze({ENTER:1,STAY:0,EXIT:-1,ENTER_EXIT:2}),Yt=new Map([["LRL",Qt.STAY],["LRR",Qt.EXIT],["LRS",Qt.EXIT],["LLL",Qt.STAY],["LLR",Qt.ENTER],["LLS",Qt.ENTER],["RRL",Qt.ENTER],["RRR",Qt.STAY],["RRS",Qt.ENTER],["RLL",Qt.EXIT],["RLR",Qt.STAY],["RLS",Qt.EXIT],["SRL",Qt.ENTER],["SRR",Qt.EXIT],["SRS",Qt.ENTER_EXIT],["SLL",Qt.EXIT],["SLR",Qt.ENTER],["SLS",Qt.ENTER_EXIT]]);function Wt(t,e){let i=t.new?t.new.interval:t.old.interval,n=e.new?e.new.interval:e.old.interval;return N.cmpLow(i,n)}function Kt(t,e){let i=t.new?t.new.interval:t.old.interval,n=e.new?e.new.interval:e.old.interval;return-1*N.cmpHigh(i,n)}function Jt(t,e=0){e>=0?t.sort(Wt):t.sort(Kt)}function Zt(t,e){return N.cmpLow(t.interval,e.interval)}function te(t,e){return-1*N.cmpHigh(t.interval,e.interval)}class ee extends ut{constructor(t){super(),this._ds=t;let e=this._onDatasetCallback.bind(this);this._ds_cb=this._ds.add_callback(e)}_movementDirection(){throw new Error("not implemented")}_sortItems(t){return Jt(t,this._movementDirection()),t}sortCues(t){return function(t,e=0){e>=0?t.sort(Zt):t.sort(te)}(t,this._movementDirection()),t}set(t,e){throw new Error("not implemented")}delete(t){throw new Error("not implemented")}get ds(){return this._ds}_onDatasetCallback(t,e){throw new Error("not implemented")}_items_from_dataset_events(t,e){const i=[],n=[],r=[],o=0==this._map.size;let s,a,l;for(let h of t.values())$t(h.delta)||(s=!o&&this._map.has(h.key),a=!1,null!=h.new&&h.new.interval.match(e)&&(a=!0),s&&!a?(l={key:h.key,new:void 0,old:h.old},r.push(l)):!s&&a?(l={key:h.key,new:h.new,old:void 0},i.push(l)):s&&a&&(l={key:h.key,new:h.new,old:h.old},n.push(l)));return[r,n,i]}_items_from_dataset_lookup(t,e){const i=new Map(this._ds.lookup(e).map((function(t){return[t.key,t]})));let n,r=[],o=[],s=0==this._map.size;if(!s){let e=h(this._map,i);if(e.size>0){let i,n;for(let o of t.values())i=e.get(o.key),null==i||$t(o.delta)||(n={key:o.key,new:o.new,old:o.old},r.push(n))}o=[...l(this._map,i).values()].map(t=>({key:t.key,new:void 0,old:t}))}return n=s?i:l(i,this._map),[o,r,[...n.values()].map(t=>({key:t.key,new:t,old:void 0}))]}}Xt(ee,"Active",Qt),Xt(ee,"ActiveMap",Yt),Xt(ee,"sort_items",Jt);var ie=ee;const ne=tt.PosDelta,re=tt.MoveDelta,oe=ie.Active,se=ie.ActiveMap;N.Relation;var ae=class extends ie{constructor(t,e){super(t),function(t,e,i){e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}(this,"_onScheduleCallback",(function(t,e,i){if(!this._to.isReady())return;const n=[];e.forEach((function(t){let e=t.cue,i=this._map.has(e.key),[r,o,s,a]=t.endpoint,l=t.direction>0?"R":"L",h=a?"S":o?"R":"L",c=se.get(`S${l}${h}`);c==oe.ENTER_EXIT?i?(n.push({key:e.key,new:void 0,old:e}),this._map.delete(e.key)):(n.push({key:e.key,new:e,old:void 0}),n.push({key:e.key,new:void 0,old:e})):c==oe.ENTER?i||(n.push({key:e.key,new:e,old:void 0}),this._map.set(e.key,e)):c==oe.EXIT&&i&&(n.push({key:e.key,new:void 0,old:e}),this._map.delete(e.key))}),this),this._notifyEvents(n)})),this._to=e,this._sub=this._to.on("timingsrc",this._onTimingCallback.bind(this)),this._sched=new Ft(this._ds,e);let i=this._onScheduleCallback.bind(this);this._sched_cb=this._sched.add_callback(i)}_movementDirection(){const t=this._to.clock.now();return j(this._to.vector,t)}_onDatasetCallback(t,e){if(!this._to.isReady())return;if(null==e)return;const i=this._to.clock.now(),n=z(this._to.vector,i),r=new N(n.position);if(!r.match(e,N.Match.OUTSIDE)){let e=this._items_from_dataset_events.bind(this);5e3<t.size&&this._map.size<5e3&&(e=this._items_from_dataset_lookup.bind(this));const[i,o,s]=e(t,r);i.forEach(t=>{this._map.delete(t.key)}),s.forEach(t=>{this._map.set(t.key,t.new)});const a=_([i,o,s],{copy:!0,order:!0});let l=j(n);ie.sort_items(a,l),this._notifyEvents(a)}this._sched.posInterval&&(this._sched.posInterval.match(e,N.Match.OUTSIDE)||this._sched.setVector(n))}_onTimingCallback(t){let e;e=t.live?this._to.vector:z(this._to.vector,this._to.clock.now());let i=new tt(this._to.old_vector,e);const n=[];if(i.posDelta==ne.CHANGE||i.moveDelta==re.STOP){let t=e.position,i=e.position,r=new N(t,i,!0,!0),o=new Map(this._ds.lookup(r).map(t=>[t.key,t])),s=l(this._map,o),a=l(o,this._map);this._map=o;for(let t of s.values())n.push({key:t.key,new:void 0,old:t});for(let t of a.values())n.push({key:t.key,new:t,old:void 0});let h=j(e);ie.sort_items(n,h),this._notifyEvents(n)}this._sched.setVector(e)}};const le=tt.PosDelta,he=tt.MoveDelta,ce=ie.Active,ue=ie.ActiveMap;N.Relation;function _e(t,e){let i=j(t)+j(e);return i>0?1:i<0?-1:0}var de=class extends ie{constructor(t,e,i){super(t),function(t,e,i){e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i}(this,"_onScheduleCallback",(function(t,e,i){if(!this._isReady())return;const n=i.to==this._toA?this._toB:this._toA,r=[];e.forEach((function(t){let[e,i,o,s]=t.endpoint,a=t.tsEndpoint[0],l=z(n.vector,a),h=l.position,c=e<h?"L":e==h?"S":"R",u=t.direction>0?"R":"L",_=s?"S":i?"R":"L",d=ue.get(`${c}${u}${_}`),f=t.cue,p=this._map.has(f.key);if(d==ce.ENTER_EXIT){if(B(l)){d=j(l)!=t.direction?ce.ENTER:ce.EXIT}else d=ce.ENTER}d==ce.STAY&&(d=ce.ENTER),d==ce.ENTER&&p||(d!=ce.EXIT||p)&&(d==ce.ENTER?(r.push({key:f.key,new:f,old:void 0}),this._map.set(f.key,f)):d==ce.EXIT&&(r.push({key:f.key,new:void 0,old:f}),this._map.delete(f.key)))}),this),this._notifyEvents(r)})),this._toA=e,this._toA_ready=!1,this._toB=i,this._toB_ready=!1;let n=this._onTimingCallback.bind(this);this._subA=this._toA.on("timingsrc",n),this._subB=this._toB.on("timingsrc",n);let r=this._onScheduleCallback.bind(this);this._schedA=new Ft(this._ds,e),this._schedA_cb=this._schedA.add_callback(r),this._schedB=new Ft(this._ds,i),this._schedB_cb=this._schedB.add_callback(r)}_isReady(){return this._toA_ready&&this._toB_ready}_movementDirection(){const t=this._toA.clock.now();return _e(z(this._toA.vector,t),z(this._toB.vector,t))}_onDatasetCallback(t,e){if(!this._isReady())return;if(null==e)return;const i=this._toA.clock.now(),n=z(this._toA.vector,i),r=z(this._toB.vector,i);let[o,s]=[n.position,r.position],[a,l]=o<=s?[o,s]:[s,o];const h=new N(a,l,!0,!0);if(!h.match(e,N.Match.OUTSIDE)){let e=this._items_from_dataset_events.bind(this);5e3<t.size&&this._map.size<5e3&&(e=this._items_from_dataset_lookup.bind(this));const[i,o,s]=e(t,h);i.forEach(t=>{this._map.delete(t.key)}),s.forEach(t=>{this._map.set(t.key,t.new)});const a=_([i,o,s],{copy:!0,order:!0});let l=_e(n,r);ie.sort_items(a,l),this._notifyEvents(a,l)}this._schedA.posInterval&&(this._schedA.posInterval.match(e,N.Match.OUTSIDE)||this._schedA.setVector(n)),this._schedB.posInterval&&(this._schedB.posInterval.match(e,N.Match.OUTSIDE)||this._schedB.setVector(r))}_onTimingCallback(t,e){let i=!1;if(!this._isReady()){if(e.src==this._toA?this._toA_ready=!0:this._toB_ready=!0,!this._isReady())return;i=!0}const n=e.src,r=n==this._toA?this._toB:this._toA;let o;o=t.live?n.vector:z(n.vector,n.clock.now());const s=new tt(n.old_vector,o);let a=o.timestamp,h=z(r.vector,a);const c=[];if(s.posDelta==le.CHANGE||s.MoveDelta==he.STOP){let t=Math.min(o.position,h.position),e=Math.max(o.position,h.position),i=new N(t,e,!0,!0),n=new Map(this._ds.lookup(i).map(t=>[t.key,t])),r=l(this._map,n),s=l(n,this._map);this._map=n;for(let t of r.values())c.push({key:t.key,new:void 0,old:t});for(let t of s.values())c.push({key:t.key,new:t,old:void 0});let a=_e(o,h);ie.sort_items(c,a),this._notifyEvents(c)}n==this._toA?this._schedA.setVector(o):n==this._toB&&this._schedB.setVector(o),i&&(r==this._toA?this._schedA.setVector(h):r==this._toB&&this._schedB.setVector(h))}};function fe(t,e,i){return void 0===i?new ae(t,e):new de(t,e,i)}const pe="v3.0"}]);